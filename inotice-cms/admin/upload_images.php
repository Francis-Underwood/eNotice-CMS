<?phprequire_once('app.php');//RequireLogin();           //Don't Run this Line because of the Uploadify: HTTP ERROR?><?php//ob_start();       //Don't Run this Line because of the Uploadify: HTTP ERRORtolog("start");//get code from the eid hidden field$iid = $_GET[id];//$image_id = (isset($_REQUEST['image_id']))?$_REQUEST['image_id']:0;$image_id = $_REQUEST['image_id'];$subject = $_REQUEST['subject'];$config_data = upload_file_config($subject,-1);//if files have been selected, upload and insert into databaseif ((!empty($_FILES)) && (!($config_data == null))) {		$ext = strtolower(end(explode(".",$_FILES['Filedata']['name']))); //get extension		//make sure the files really are just image files		//$allowed = array("jpg","png","gif");	//if (!in_array($ext,$allowed)) {		//die;	//}	//	//upload the file		//檔案命名	$Name = date("Ymd") . "_" . substr(md5(uniqid(rand())),0,5) . substr(md5(uniqid(rand())),0,5) . substr(md5(uniqid(rand())),0,5) . "." . $ext;		//get file information	$tempFile = $_FILES['Filedata']['tmp_name'];	$targetPath = $_SERVER['DOCUMENT_ROOT'] . $_REQUEST['folder'] . '/';	//$targetFile =  str_replace('//','/',$targetPath) . $_FILES['Filedata']['name'];	$targetFile =  str_replace('//','/',$targetPath) . $Name;		//*Check the Image Resolution*	$resolution_matched = false;	//$err_msg = "Incorrect resolution for [".$_FILES['Filedata']['name']."], should be ".$config_data['best_resolution_text']."!<br>";		$err_msg = "Incorrect image resolution, should be ".$config_data['best_resolution_text']."!<br>";		$best_resolution = explode(" x ", $config_data['best_resolution_text']);	$matched_width = $best_resolution[0];	$matched_height = $best_resolution[1];		switch ($subject)        {   			case "logo":            case "bg":			case "menu_icons":			            case "banner_image":			case "news":			case "about_us":            if (check_image_resolution($tempFile,$matched_width,$matched_height,0)) {					$resolution_matched = true;					Save_err_msg("");			}				else					Save_err_msg($err_msg);							break;            default:				$resolution_matched = true;				Save_err_msg("");            break;        }	//upload the Image Resolution if the resolution is match the requirement if ($resolution_matched)   { 	//move_uploaded_file($tempFile,$targetFile);	if (move_uploaded_file($tempFile,$targetFile))  {		/*  Echo Error Messasge	switch ($_FILES['Filedata']['error'])        {                 case 0:             $msg = ""; // comment this out if you don't want a message to appear on success.             break;            case 1:              $msg = "The file is bigger than this PHP installation allows";              break;            case 2:              $msg = "The file is bigger than this form allows";              break;            case 3:              $msg = "Only part of the file was uploaded";              break;            case 4:             $msg = "No file was uploaded";              break;            case 6:             $msg = "Missing a temporary folder";              break;            case 7:             $msg = "Failed to write file to disk";             break;            case 8:             $msg = "File upload stopped by extension";             break;            default:            $msg = "unknown error ".$_FILES['Filedata']['error'];            break;        }    }    if ($msg)        { $stringData = "Error: ".$_FILES['Filedata']['error']." Error Info: ".$msg; }    else        { $stringData = "1"; } // This is required for onComplete to fire on Mac OSX    echo $stringData;  */		//最佳尺寸	if ($config_data['best_max_width'] > 0) {		$src  = $targetPath . "/" . $Name;		$dest1 = $targetPath . "/best/" . $Name;		$destW = $config_data['best_max_width'];		$destH = 1;		imagesResize($src,$dest1,$destW,$destH);	}		//預覽圖	if ($config_data['thumb_max_width'] > 0) {		$src  = $targetPath . "/" . $Name;		$dest1 = $targetPath . "/thumb/" . $Name;		$destW = $config_data['thumb_max_width'];		$destH = 1;				switch ($subject)        {   			case "news":            case "gallery":				imagesResize_square($src,$dest1,$destW);				break;            default:				imagesResize($src,$dest1,$destW,$destH);            break;        }	}		//正方形封面圖片	if ($config_data['cover_max_width'] > 0) {		$src  = $targetPath . "/" . $Name;		$dest1 = $targetPath . "/cover/" . $Name;		$destW = $config_data['cover_max_width'];		imagesResize_square($src,$dest1,$destW);	}		//Update the file name into the database	switch ($subject)        {                 case "news":            $id2 = $_REQUEST['news_id'];             break;            case "gallery":            $id2 = $_REQUEST['aid'];             break;            default:            $id2 = 0;            break;        }	Update_images($subject, $image_id, $Name, $_FILES['Filedata']['name'], $id2);		//echo the file name	echo str_replace($_SERVER['DOCUMENT_ROOT'],'',$targetFile);		}  }}//?> 