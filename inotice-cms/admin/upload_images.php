<?phprequire_once('app.php');//RequireLogin();           //Don't Run this Line because of the Uploadify: HTTP ERROR?><?php//ob_start();       //Don't Run this Line because of the Uploadify: HTTP ERRORtolog("start");//get code from the eid hidden field$iid = $_GET[id];//$image_id = (isset($_REQUEST['image_id']))?$_REQUEST['image_id']:0;$image_id = $_REQUEST['image_id'];$subject = $_REQUEST['subject'];$config_data = upload_file_config($subject,-1);//if files have been selected, upload and insert into databaseif ((!empty($_FILES)) && (!($config_data == null))) {		$ext = strtolower(end(explode(".",$_FILES['Filedata']['name']))); //get extension		//Upload the file		//檔案命名	$Name = date("Ymd") . "_" . substr(md5(uniqid(rand())),0,5) . substr(md5(uniqid(rand())),0,5) . substr(md5(uniqid(rand())),0,5) . "." . $ext;		//get file information	$tempFile = $_FILES['Filedata']['tmp_name'];	$targetPath = $_SERVER['DOCUMENT_ROOT'] . $_REQUEST['folder'] . '/';	//$targetFile =  str_replace('//','/',$targetPath) . $_FILES['Filedata']['name'];	$targetFile =  str_replace('//','/',$targetPath) . $Name;		$pass = true;	Save_err_msg("");		//**Check File Extension***		/*make sure the files really are just image files	   <----No Need check, because it already checked by uploadify	//$allowed = array("jpg","png","gif");	//if (!in_array($ext,$allowed)) {		//die;	//}	*/		$allowed_ext_str = str_replace("*.", "", $config_data['fileExt']);	$allowed_ext = explode(";", $allowed_ext_str);	if (!in_array($ext,$allowed_ext)) {		$pass = false;		$err_msg = "Incorrect file type, should be <u>".$config_data['fileDesc']."</u> (".$config_data['fileExt'].")!<br>";		Save_err_msg($err_msg);	}			//**Check the Image Resolution**		//###根據長闊值###		if ($pass) {		if (($config_data['best_resolution_text']) != "")  {			$pass = false;			//$err_msg = "Incorrect resolution for [".$_FILES['Filedata']['name']."], should be at least ".$config_data['best_resolution_text']."!<br>";				$err_msg = "Incorrect image resolution, should be <u>".strtoupper("at least")."</u> ".$config_data['best_resolution_text']."!<br>";						$best_resolution = explode(" x ", $config_data['best_resolution_text']);			$matched_width = $best_resolution[0];			$matched_height = $best_resolution[1];					if (check_image_min_resolution($tempFile,$matched_width,$matched_height,0)) {					$pass = true;					Save_err_msg("");			}				else Save_err_msg($err_msg);		}	}		//###根據長闊比例###		if ($pass) {		if (($config_data['best_ratio_range']) != "")  {			$pass = false;			$err_msg = "Incorrect image resolution ratio, should be between ".$config_data['best_ratio_range']."!<br>";						$best_ratio = explode(" - ", $config_data['best_ratio_range']);			$min_ratio = $best_ratio[0];			$max_ratio = $best_ratio[1];					if (check_image_resolution_ratio($tempFile,$min_ratio,$max_ratio)) {					$pass = true;					Save_err_msg("");			}				else Save_err_msg($err_msg);		}		}	//Upload the Image if the file type & resolution are match the requirement if ($pass)   { 	//move_uploaded_file($tempFile,$targetFile);	if (move_uploaded_file($tempFile,$targetFile))  {		/*  Echo Error Messasge	switch ($_FILES['Filedata']['error'])        {                 case 0:             $msg = ""; // comment this out if you don't want a message to appear on success.             break;            case 1:              $msg = "The file is bigger than this PHP installation allows";              break;            case 2:              $msg = "The file is bigger than this form allows";              break;            case 3:              $msg = "Only part of the file was uploaded";              break;            case 4:             $msg = "No file was uploaded";              break;            case 6:             $msg = "Missing a temporary folder";              break;            case 7:             $msg = "Failed to write file to disk";             break;            case 8:             $msg = "File upload stopped by extension";             break;            default:            $msg = "unknown error ".$_FILES['Filedata']['error'];            break;        }    }    if ($msg)        { $stringData = "Error: ".$_FILES['Filedata']['error']." Error Info: ".$msg; }    else        { $stringData = "1"; } // This is required for onComplete to fire on Mac OSX    echo $stringData;  */		//最佳尺寸	if ($config_data['best_max_width'] > 0) {		$src  = $targetPath . "/" . $Name;		$dest1 = $targetPath . "/best/" . $Name;		$destW = $config_data['best_max_width'];		$destH = 1;		imagesResize($src,$dest1,$destW,$destH);	}		//預覽圖	if ($config_data['thumb_max_width'] > 0) {		$src  = $targetPath . "/" . $Name;		$dest1 = $targetPath . "/thumb/" . $Name;		$destW = $config_data['thumb_max_width'];		$destH = 1;				switch ($subject)        {   			case "news":            case "gallery":				imagesResize_square($src,$dest1,$destW);				break;            default:				imagesResize($src,$dest1,$destW,$destH);            break;        }	}		//正方形封面圖片	if ($config_data['cover_max_width'] > 0) {		$src  = $targetPath . "/" . $Name;		$dest1 = $targetPath . "/cover/" . $Name;		$destW = $config_data['cover_max_width'];		imagesResize_square($src,$dest1,$destW);	}		//檢查解析度，如果不等於指定的...	if (($config_data['fixed_resolution'])) {		$finished_resolution = explode(" x ", $config_data['finished_resolution_text']);		$matched_finished_width = $finished_resolution[0];		$matched_finished_height = $finished_resolution[1];				$resolution_matched = false;		$src  = $targetPath . "/" . $Name;		//如果完全符合指定大細，不做任何動作		if (check_image_resolution($src,$matched_finished_width,$matched_finished_height,0)) {			$resolution_matched = true;		}		else		{			//取得檔案資訊			$srcSize = getimagesize($src);			$width = $srcSize[0];			$height = $srcSize[1];				//如果長或闊任何一個大於指定的，把圖片移至non-crop，讓用戶自行設定位置			if (($width > $matched_finished_width) || ($height > $matched_finished_height))			{				rename($src, $targetPath . "/non-crop/" . $Name) or die("Unable to move $old to $new.");			}			else			{				//否則自動把圖片裁為置中，並Save 到原來位置				imagesResize_custom($src, $src, 0, 0, $matched_finished_width, $matched_finished_height, $width, $height);			}					}	}		//Update the file name into the database	switch ($subject)        {                 case "news":            $id2 = $_REQUEST['news_id'];             break;            case "gallery":            $id2 = $_REQUEST['aid'];             break;            default:            $id2 = 0;            break;        }	Update_images($subject, $image_id, $Name, $_FILES['Filedata']['name'], $id2);		//echo the file name	echo str_replace($_SERVER['DOCUMENT_ROOT'],'',$targetFile);		}  }}//?> 